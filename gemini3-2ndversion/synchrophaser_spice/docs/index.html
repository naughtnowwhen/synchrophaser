<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synchrophaser PLL Digital Twin</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⚙️</text></svg>">

    <!-- PyScript (legacy stable version) -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2023.12.1/pyscript.css">
    <script defer src="https://pyscript.net/releases/2023.12.1/pyscript.js"></script>

    <style>
        :root {
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --accent: #0f3460;
            --highlight: #e94560;
            --text: #eee;
            --text-dim: #aaa;
            --success: #00d26a;
            --warning: #ffc107;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
        }

        header {
            background: linear-gradient(135deg, var(--bg-card), var(--accent));
            padding: 1.5rem 2rem;
            border-bottom: 2px solid var(--highlight);
        }

        header h1 {
            font-size: 1.8rem;
            font-weight: 600;
        }

        header p {
            color: var(--text-dim);
            margin-top: 0.3rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .tab-btn {
            padding: 0.8rem 1.5rem;
            background: var(--bg-card);
            border: none;
            color: var(--text);
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            background: var(--accent);
        }

        .tab-btn.active {
            background: var(--highlight);
            font-weight: 600;
        }

        .tab-content {
            display: none;
            background: var(--bg-card);
            border-radius: 0 8px 8px 8px;
            padding: 1.5rem;
            min-height: 600px;
        }

        .tab-content.active {
            display: block;
        }

        /* Simulation Panel */
        .sim-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 1.5rem;
        }

        .controls {
            background: var(--accent);
            padding: 1rem;
            border-radius: 8px;
        }

        .control-group {
            margin-bottom: 1.5rem;
        }

        .control-group h3 {
            font-size: 0.9rem;
            color: var(--text-dim);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .slider-container {
            margin: 0.8rem 0;
        }

        .slider-container label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.3rem;
            font-size: 0.9rem;
        }

        .slider-container input[type="range"] {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            background: var(--bg-dark);
            border-radius: 3px;
            outline: none;
        }

        .slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--highlight);
            border-radius: 50%;
            cursor: pointer;
        }

        button.action-btn {
            width: 100%;
            padding: 0.8rem;
            margin: 0.3rem 0;
            background: var(--highlight);
            border: none;
            color: white;
            font-size: 0.95rem;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
        }

        button.action-btn:hover {
            opacity: 0.9;
            transform: scale(1.02);
        }

        button.action-btn:disabled {
            background: #555;
            cursor: not-allowed;
        }

        button.action-btn.secondary {
            background: var(--accent);
            border: 1px solid var(--highlight);
        }

        /* Status Display */
        .status-panel {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .status-card {
            background: var(--accent);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .status-card .value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--highlight);
        }

        .status-card .label {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-top: 0.3rem;
        }

        .status-card.locked .value {
            color: var(--success);
        }

        /* Canvas */
        #sim-canvas {
            width: 100%;
            height: 500px;
            background: var(--bg-dark);
            border-radius: 8px;
            border: 1px solid var(--accent);
        }

        /* Loading indicator */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 400px;
            color: var(--text-dim);
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--accent);
            border-top-color: var(--highlight);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Progress bar */
        .progress-container {
            width: 300px;
            margin: 1rem 0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-dark);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--highlight), var(--success));
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            margin-top: 0.5rem;
            color: var(--text-dim);
        }

        .load-stage {
            font-size: 0.85rem;
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        .load-details {
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-top: 0.3rem;
        }

        /* Schematic iframe */
        #schematic-frame {
            width: 100%;
            height: 800px;
            border: none;
            border-radius: 8px;
        }

        /* Component info */
        .component-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .component-card {
            background: var(--accent);
            padding: 1rem;
            border-radius: 8px;
            border-left: 3px solid var(--highlight);
        }

        .component-card h4 {
            color: var(--highlight);
            margin-bottom: 0.5rem;
        }

        .component-card ul {
            list-style: none;
            font-size: 0.9rem;
            color: var(--text-dim);
        }

        .component-card li {
            padding: 0.2rem 0;
        }

        .component-card li::before {
            content: "• ";
            color: var(--highlight);
        }

        footer {
            text-align: center;
            padding: 1.5rem;
            color: var(--text-dim);
            font-size: 0.85rem;
        }

        footer a {
            color: var(--highlight);
            text-decoration: none;
        }
    </style>
</head>
<body>
    <header>
        <h1>Synchrophaser PLL Digital Twin</h1>
        <p>Type-II Charge Pump Phase-Locked Loop for Aircraft Propeller Synchronization | 42 Components</p>
    </header>

    <div class="container">
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('simulation')">Live Simulation</button>
            <button class="tab-btn" onclick="showTab('schematic')">Circuit Schematic</button>
            <button class="tab-btn" onclick="showTab('components')">Component Details</button>
        </div>

        <!-- Simulation Tab -->
        <div id="simulation" class="tab-content active">
            <div class="status-panel">
                <div class="status-card">
                    <div class="value" id="rpm-main">900</div>
                    <div class="label">Main Prop (RPM)</div>
                </div>
                <div class="status-card">
                    <div class="value" id="rpm-follower">885</div>
                    <div class="label">Follower Prop (RPM)</div>
                </div>
                <div class="status-card">
                    <div class="value" id="phase-error">45.0°</div>
                    <div class="label">Phase Error</div>
                </div>
                <div class="status-card" id="lock-status">
                    <div class="value">UNLOCKED</div>
                    <div class="label">Lock Status</div>
                </div>
            </div>

            <div class="sim-grid">
                <div class="controls">
                    <div class="control-group">
                        <h3>Initial Conditions</h3>
                        <div class="slider-container">
                            <label>
                                <span>Main RPM</span>
                                <span id="main-rpm-val">900</span>
                            </label>
                            <input type="range" id="main-rpm" min="800" max="1000" value="900"
                                   oninput="updateSlider('main-rpm')">
                        </div>
                        <div class="slider-container">
                            <label>
                                <span>Follower RPM</span>
                                <span id="follower-rpm-val">885</span>
                            </label>
                            <input type="range" id="follower-rpm" min="800" max="1000" value="885"
                                   oninput="updateSlider('follower-rpm')">
                        </div>
                        <div class="slider-container">
                            <label>
                                <span>Phase Offset</span>
                                <span id="phase-offset-val">45°</span>
                            </label>
                            <input type="range" id="phase-offset" min="0" max="180" value="45"
                                   oninput="updateSlider('phase-offset')">
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>PLL Parameters</h3>
                        <div class="slider-container">
                            <label>
                                <span>Kvco (Hz/V)</span>
                                <span id="kvco-val">15</span>
                            </label>
                            <input type="range" id="kvco" min="5" max="30" value="15"
                                   oninput="updateSlider('kvco')">
                        </div>
                        <div class="slider-container">
                            <label>
                                <span>I_cp (mA)</span>
                                <span id="icp-val">1.0</span>
                            </label>
                            <input type="range" id="icp" min="0.1" max="2" value="1" step="0.1"
                                   oninput="updateSlider('icp')">
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>Simulation</h3>
                        <button class="action-btn" id="start-btn" onclick="startSimulation()">
                            Start Simulation
                        </button>
                        <button class="action-btn secondary" onclick="resetSimulation()">
                            Reset
                        </button>
                        <button class="action-btn secondary" onclick="applyDisturbance()">
                            Apply Disturbance
                        </button>
                    </div>
                </div>

                <div id="canvas-container">
                    <div class="loading" id="loading">
                        <div class="spinner"></div>
                        <p class="load-stage" id="load-stage">Initializing PyScript...</p>
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progress-fill"></div>
                            </div>
                            <div class="progress-text">
                                <span id="progress-label">Starting...</span>
                                <span id="progress-percent">0%</span>
                            </div>
                        </div>
                        <p class="load-details" id="load-details">First load downloads ~15MB (Pyodide + NumPy)</p>
                    </div>
                    <canvas id="sim-canvas" style="display: none;"></canvas>
                </div>
            </div>
        </div>

        <!-- Schematic Tab -->
        <div id="schematic" class="tab-content">
            <iframe id="schematic-frame" src="schematic.html"></iframe>
        </div>

        <!-- Components Tab -->
        <div id="components" class="tab-content">
            <h2 style="margin-bottom: 1rem;">42-Component Bill of Materials</h2>
            <div class="component-grid">
                <div class="component-card">
                    <h4>Power Supply (7)</h4>
                    <ul>
                        <li>VAC - 120V 60Hz AC input</li>
                        <li>D1-D4 - Bridge rectifier</li>
                        <li>C_filter - 1000µF bulk cap</li>
                        <li>C_in - 0.33µF input stability</li>
                        <li>7805 - 5V LDO regulator</li>
                        <li>C_out - 0.1µF output stability</li>
                        <li>C_dec - 100µF decoupling</li>
                    </ul>
                </div>
                <div class="component-card">
                    <h4>Signal Conditioning REF (4)</h4>
                    <ul>
                        <li>Sensor - Hall/Optical detector</li>
                        <li>R_pullup - 10kΩ pull-up</li>
                        <li>C_filt - 100nF RC filter</li>
                        <li>U_SCHMITT - 74HC14 trigger</li>
                    </ul>
                </div>
                <div class="component-card">
                    <h4>Phase/Frequency Detector (4)</h4>
                    <ul>
                        <li>DFF1 - D Flip-Flop (REF)</li>
                        <li>DFF2 - D Flip-Flop (FB)</li>
                        <li>AND - Reset gate</li>
                        <li>DLY - ~1ns delay element</li>
                    </ul>
                </div>
                <div class="component-card">
                    <h4>Charge Pump (5)</h4>
                    <ul>
                        <li>R_set - 5kΩ bias resistor</li>
                        <li>M1 - PMOS current mirror</li>
                        <li>M2 - PMOS UP switch</li>
                        <li>M3 - NMOS DN switch</li>
                        <li>M4 - NMOS current mirror</li>
                    </ul>
                </div>
                <div class="component-card">
                    <h4>Loop Filter (4)</h4>
                    <ul>
                        <li>Rz - 680Ω damping resistor</li>
                        <li>ESR - ~1Ω parasitic</li>
                        <li>Cint - 100µF integrator</li>
                        <li>C_hf - 100nF HF bypass</li>
                    </ul>
                </div>
                <div class="component-card">
                    <h4>VCO (5)</h4>
                    <ul>
                        <li>C_dec - 100nF decoupling</li>
                        <li>R_timing - ~80kΩ variable</li>
                        <li>C_timing - 10nF COG</li>
                        <li>Varactor - V-controlled cap</li>
                        <li>OSC - Relaxation oscillator</li>
                    </ul>
                </div>
                <div class="component-card">
                    <h4>Motor Driver (5)</h4>
                    <ul>
                        <li>R_f2v - 10kΩ F/V resistor</li>
                        <li>C_f2v - 1µF F/V capacitor</li>
                        <li>H-Bridge - Power MOSFETs</li>
                        <li>D_flyback - 1N4148 protection</li>
                        <li>Motor - τ=22ms DC motor</li>
                    </ul>
                </div>
                <div class="component-card">
                    <h4>Signal Conditioning FB (4)</h4>
                    <ul>
                        <li>Sensor - Hall/Optical (FB)</li>
                        <li>R_pullup_fb - 10kΩ</li>
                        <li>C_filter_fb - 100nF</li>
                        <li>Schmitt - 74HC14 (shared)</li>
                    </ul>
                </div>
                <div class="component-card">
                    <h4>Lock Detector (6)</h4>
                    <ul>
                        <li>XOR - 74HC86 phase detect</li>
                        <li>R_lpf - 100kΩ filter</li>
                        <li>C_lpf - 1µF filter</li>
                        <li>Comp - Comparator w/hyst</li>
                        <li>R_led - 330Ω current limit</li>
                        <li>LED - Green 3mm lock indicator</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p>Synchrophaser PLL Digital Twin |
           <a href="https://github.com/petermurphy" target="_blank">GitHub</a> |
           Built with PyScript
        </p>
    </footer>

    <script>
        // Loading progress tracking
        const loadStages = [
            { name: 'Initializing PyScript...', detail: 'Setting up runtime environment', pct: 5 },
            { name: 'Downloading Pyodide...', detail: 'Python interpreter (~10MB)', pct: 15 },
            { name: 'Loading Python runtime...', detail: 'Initializing WebAssembly', pct: 40 },
            { name: 'Installing NumPy...', detail: 'Scientific computing library (~5MB)', pct: 60 },
            { name: 'Loading simulation code...', detail: 'PLL simulation engine', pct: 85 },
            { name: 'Initializing canvas...', detail: 'Almost ready!', pct: 95 },
        ];

        let currentStage = 0;
        let loadStartTime = Date.now();

        function updateProgress(stage, percent, detail) {
            const fill = document.getElementById('progress-fill');
            const label = document.getElementById('progress-label');
            const pctText = document.getElementById('progress-percent');
            const stageText = document.getElementById('load-stage');
            const detailText = document.getElementById('load-details');

            if (fill) fill.style.width = percent + '%';
            if (pctText) pctText.textContent = percent + '%';
            if (stageText) stageText.textContent = stage;
            if (label) {
                const elapsed = ((Date.now() - loadStartTime) / 1000).toFixed(1);
                label.textContent = elapsed + 's elapsed';
            }
            if (detailText && detail) detailText.textContent = detail;
        }

        // Simulate progress while waiting (will be overridden by actual events)
        function simulateProgress() {
            if (currentStage < loadStages.length) {
                const stage = loadStages[currentStage];
                updateProgress(stage.name, stage.pct, stage.detail);
                currentStage++;
                // Varying delays to simulate real loading
                const delay = currentStage < 3 ? 800 : 2000;
                setTimeout(simulateProgress, delay);
            }
        }

        // Start simulated progress
        setTimeout(simulateProgress, 500);

        // Listen for PyScript events (2023 version uses different events)
        document.addEventListener('py:ready', () => {
            console.log('PyScript event: py:ready');
            updateProgress('Python ready!', 90, 'Loading simulation module...');
        });

        document.addEventListener('py:all-done', () => {
            console.log('PyScript event: py:all-done');
            updateProgress('Complete!', 100, 'Simulation ready');
        });

        // Also listen for pyscript-ready (older event name)
        window.addEventListener('pyscript-ready', () => {
            console.log('PyScript event: pyscript-ready (legacy)');
            updateProgress('Python ready!', 92, 'Initializing...');
        });

        // Tab switching
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        // Slider updates
        function updateSlider(id) {
            const slider = document.getElementById(id);
            const valSpan = document.getElementById(id + '-val');
            let val = slider.value;

            if (id === 'phase-offset') val += '°';
            else if (id === 'icp') val = parseFloat(val).toFixed(1);

            valSpan.textContent = val;
        }

        // Simulation controls (will be connected to PyScript)
        function startSimulation() {
            if (window.pySimulation) {
                window.pySimulation.start();
            }
        }

        function resetSimulation() {
            if (window.pySimulation) {
                window.pySimulation.reset();
            }
        }

        function applyDisturbance() {
            if (window.pySimulation) {
                window.pySimulation.disturb();
            }
        }
    </script>

    <!-- PyScript Configuration (2023 format) -->
    <py-config>
packages = ["numpy"]
    </py-config>

    <!-- PyScript Simulation -->
    <py-script src="./src/simulation.py"></py-script>
</body>
</html>
